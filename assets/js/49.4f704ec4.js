(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{356:function(t,s,n){"use strict";n.r(s);var a=n(1),e=Object(a.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),n("p",[t._v("优点：减小响应体，降低数据传输时间，降低流量。\n缺点：压缩需要消耗服务端一定的计算性能和计算时间。")]),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),n("p",[t._v("首先需要了解两个库："),n("a",{attrs:{href:"https://www.npmjs.com/package/compression",target:"_blank",rel:"noopener noreferrer"}},[t._v("compression"),n("OutboundLink")],1),t._v(","),n("a",{attrs:{href:"https://www.npmjs.com/package/express-static-gzip",target:"_blank",rel:"noopener noreferrer"}},[t._v("express-static-gzip"),n("OutboundLink")],1),t._v("。")]),t._v(" "),t._m(16),t._v(" "),t._m(17),t._v(" "),t._m(18),t._m(19),t._v(" "),n("p",[t._v("举一个例子来说，假如前端使用vue/react来开发，服务端采用nodejs，并且不采用分离部署的方式，而是直接将前端构建结果丢到express的静态资源中。在前端的构建过程中，已经将gzip生成好了。")]),t._v(" "),t._m(20),t._m(21),t._v(" "),n("p",[t._v("为了让我们的预压缩资源生效，我们需要对此做出改变：当请求资源为静态资源，且有预压缩文件时，返回预压缩文件；否则，压缩返回。")]),t._v(" "),t._m(22),t._v(" "),t._m(23),n("p",[t._v("需要注意的是，如果按照此方法使用，一定要将"),n("code",[t._v("expressStaticGzip")]),t._v("中"),n("code",[t._v("options.index")]),t._v("设置为false，否则"),n("code",[t._v("expressStaticGzip")]),t._v("在需要下坠的情况会错误的执行next()。原因可查看相关"),n("a",{attrs:{href:"https://github.com/tkoenig89/express-static-gzip/issues/31",target:"_blank",rel:"noopener noreferrer"}},[t._v("issue"),n("OutboundLink")],1)]),t._v(" "),t._m(24),t._v(" "),n("ol",[n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Encoding",target:"_blank",rel:"noopener noreferrer"}},[t._v("Accept-Encoding"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Encoding",target:"_blank",rel:"noopener noreferrer"}},[t._v("Content-Encoding"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Vary",target:"_blank",rel:"noopener noreferrer"}},[t._v("Vary"),n("OutboundLink")],1)])])])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"http-compression"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#http-compression","aria-hidden":"true"}},[this._v("#")]),this._v(" HTTP-compression")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在HTTP优化中，可以通过减小HTTP响应的大小来减少响应时间。为实现减小HTTP响应的大小，可以对响应体进行压缩，通常使用的压缩方法是"),s("code",[this._v("Gzip")]),this._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"启用gzip"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启用gzip","aria-hidden":"true"}},[this._v("#")]),this._v(" 启用Gzip")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("客户端在发起请求时，在header添加"),n("code",[t._v("Accept-Encoding")]),t._v("头，来声明一系列的可以支持压缩模式。"),n("br"),t._v(" "),n("code",[t._v("Accept-Encoding: gzip, deflate")]),t._v("：客户端可支持的压缩模式："),n("code",[t._v("gzip")]),t._v("、"),n("code",[t._v("deflate")]),t._v("。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("服务端接受到请求后，寻找"),n("code",[t._v("Accept-Encoding")]),t._v("中自身可支持的编码，而后进行响应，并且在响应中设置"),n("code",[t._v("Content-Encoding")]),t._v("首部提供了实际采用的压缩模式。\n"),n("code",[t._v("Content-Encoding: gzip")]),t._v("，这里表明服务端使用"),n("code",[t._v("gzip")]),t._v("模式进行压缩编码。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("客户端得到响应结果，识别响应头"),s("code",[this._v("Content-Encoding: gzip")]),this._v("，而后对响应体进行"),s("code",[this._v("gzip")]),this._v("解压，再做下一步处理。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("对于浏览器来说，解压"),s("code",[this._v("gzip")]),this._v("等操作由浏览器提供，并自动处理。在web开发的过程中，我们并不需要对响应压缩进行处理，浏览器会替我们搞定。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"压缩的优缺点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#压缩的优缺点","aria-hidden":"true"}},[this._v("#")]),this._v(" 压缩的优缺点")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"压缩什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#压缩什么","aria-hidden":"true"}},[this._v("#")]),this._v(" 压缩什么")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("一般建议对数据尽可能地进行压缩。不过对于特定类型的文件来说，比如jpeg图片文件，已经是进行过压缩的了。有时候再次进行额外的压缩无助于负载体积的减小，反而有可能会使其增大。"),s("br"),this._v("\n所以需要避免对这种特定类型文件的压缩，避免收益小于消耗的情况发生。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"压缩等级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#压缩等级","aria-hidden":"true"}},[this._v("#")]),this._v(" 压缩等级")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("gzip的压缩可分为1-9，9个等级，等级越高压缩率越高。在HTTP中，并不是压缩的越狠越好，更高的压缩率也需要更高的计算性能和时间消耗，所以要综合考虑。"),n("br"),t._v("\n在nodejs中的zlib库中，"),n("code",[t._v("zlib.Z_DEFAULT_COMPRESSION = 6")]),t._v("，也就是6压缩等级。"),n("code",[t._v("compression")]),t._v("库中依赖"),n("code",[t._v("zlib")]),t._v("压缩，默认也是使用的这个压缩等级。\n在"),n("code",[t._v("compression-webpack-plugin")]),t._v("中情况有所不同，参数"),n("code",[t._v("compressionOptions.level")]),t._v("用于指定压缩等级，它的默认值是9，也就是最高的压缩等级。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("为何会出现这样的状况，我认为是使用情况不同。在服务端，需要综合考虑压缩计算性能及时间的消耗。压缩率太高，计算时间长，性能消耗大；压缩率太低，计算时间短，但压缩结果与未压缩相差不大，显得压缩没有必要。所以了一个中间结果，也就是等级6。"),s("br"),this._v("\n而"),s("code",[this._v("compression-webpack-plugin")]),this._v("用于构建阶段，并不需要考虑压缩时间的问题，即使长一点也没关系。所以尽可能的将文件压缩小，也就默认使用最高的压缩等级。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"针对代理服务器的处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#针对代理服务器的处理","aria-hidden":"true"}},[this._v("#")]),this._v(" 针对代理服务器的处理")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("当使用代理服务器时，需要在被代理服务中设置"),s("code",[this._v("Vary: Accept-Encoding")]),this._v("头，告诉代理服务器缓存两种版本的资源：压缩和非压缩。这有助于避免一些公共代理不能正确地检测Content-Encoding标头的问题。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"在express项目中开启gzip"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在express项目中开启gzip","aria-hidden":"true"}},[this._v("#")]),this._v(" 在Express项目中开启gzip")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"默认情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#默认情况","aria-hidden":"true"}},[this._v("#")]),this._v(" 默认情况")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在Express中，可以直接使用"),s("code",[this._v("compression")]),this._v("直接开启gzip。")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" express "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'express'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" compression "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'compression'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("express")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napp"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("use")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("compression")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" filter"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" shouldCompress "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"存在预压缩文件的情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#存在预压缩文件的情况","aria-hidden":"true"}},[this._v("#")]),this._v(" 存在预压缩文件的情况")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language-file extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[this._v("index.html\nmain.js\nmain.js.gz\nstyle.css\nstyle.css.gz\n")])])])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("p",[t._v("此时再使用"),n("code",[t._v("compression")]),t._v("就显得有些傻了，因为无论请求的内容是否已经存在预编译gzip，"),n("code",[t._v("compression")]),t._v("都不会关心，它只会勤勤恳恳的将内容压缩。比如我们请求"),n("code",[t._v("main.js")]),t._v("，实际上已经存在"),n("code",[t._v("main.js.gz")]),t._v("的预压缩文件，服务器把它直接返回就好了。但"),n("code",[t._v("compression")]),t._v("不会这么做，而是消耗时间和性能，将"),n("code",[t._v("main.js")]),t._v("压缩。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这里就需要使用到"),s("code",[this._v("express-static-gzip")]),this._v("库，来对静态文件进行处理：")])},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" express "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'express'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" expressStaticGzip "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'express-static-gzip'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" compression "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("require")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'compression'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("express")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// Tip：此代码需移除。")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// app.use(express.static(path.join(__dirname, 'public')))")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 针对有预编译的静态资源，直接返回预编译结果")]),t._v("\napp"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("use")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("'/'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("expressStaticGzip")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("join")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'public'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  index"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("false")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  serveStatic"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    index"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'index.html'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 其他情况压缩")]),t._v("\napp"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("use")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("compression")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"reference"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reference","aria-hidden":"true"}},[this._v("#")]),this._v(" reference")])}],!1,null,null,null);s.default=e.exports}}]);